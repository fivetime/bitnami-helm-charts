CHART NAME: {{ .Chart.Name }}
CHART VERSION: {{ .Chart.Version }}
APP VERSION: {{ .Chart.AppVersion }}

-------------------------------------------------------------------------------
 DNSdist å·²æˆåŠŸéƒ¨ç½²ï¼
-------------------------------------------------------------------------------

{{- if .Values.diagnosticMode.enabled }}

âš ï¸  è¯Šæ–­æ¨¡å¼å·²å¯ç”¨

æ‰€æœ‰æ¢é’ˆå·²ç¦ç”¨ï¼Œå®¹å™¨å‘½ä»¤å·²è¦†ç›–ä¸º:
  command: {{- include "common.tplvalues.render" (dict "value" .Values.diagnosticMode.command "context" $) | nindent 4 }}
  args: {{- include "common.tplvalues.render" (dict "value" .Values.diagnosticMode.args "context" $) | nindent 4 }}

è·å– Pod åˆ—è¡¨:
  kubectl get pods --namespace {{ include "common.names.namespace" . }} -l app.kubernetes.io/instance={{ .Release.Name }}

è¿›å…¥ Pod è¿›è¡Œè°ƒè¯•:
  kubectl exec -it --namespace {{ include "common.names.namespace" . }} <POD_NAME> -- bash

{{- else }}

{{- if .Values.service.enabled }}

1. è·å– DNSdist æœåŠ¡åœ°å€
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

{{- if eq .Values.service.type "LoadBalancer" }}

   ç­‰å¾… LoadBalancer IP åˆ†é… (å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿ):

   kubectl get svc --namespace {{ include "common.names.namespace" . }} {{ include "common.names.fullname" . }} -w

   è·å– DNS æœåŠ¡åœ°å€:

   export DNS_IP=$(kubectl get svc --namespace {{ include "common.names.namespace" . }} {{ include "common.names.fullname" . }} \
     -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
   echo "DNS æœåŠ¡å™¨: $DNS_IP"

{{- else if eq .Values.service.type "ClusterIP" }}

   è·å– ClusterIP:

   export DNS_IP=$(kubectl get svc --namespace {{ include "common.names.namespace" . }} {{ include "common.names.fullname" . }} \
     -o jsonpath='{.spec.clusterIP}')
   echo "DNS æœåŠ¡å™¨: $DNS_IP"

   ç«¯å£è½¬å‘ (ç”¨äºæœ¬åœ°æµ‹è¯•):

   kubectl port-forward --namespace {{ include "common.names.namespace" . }} svc/{{ include "common.names.fullname" . }} 5353:53

{{- else if eq .Values.service.type "NodePort" }}

   è·å– NodePort:

   export NODE_IP=$(kubectl get nodes -o jsonpath='{.items[0].status.addresses[?(@.type=="ExternalIP")].address}')
   export NODE_PORT=$(kubectl get svc --namespace {{ include "common.names.namespace" . }} {{ include "common.names.fullname" . }} \
     -o jsonpath='{.spec.ports[?(@.name=="dns-udp")].nodePort}')
   echo "DNS æœåŠ¡å™¨: $NODE_IP:$NODE_PORT"

{{- end }}

2. æµ‹è¯• DNS è§£æ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   # åŸºæœ¬ DNS æŸ¥è¯¢
   dig @$DNS_IP example.com

   # æŒ‡å®šæŸ¥è¯¢ç±»å‹
   dig @$DNS_IP example.com MX
   dig @$DNS_IP example.com AAAA

{{- end }}

{{- if and .Values.listeners.dot.enabled (include "dnsdist.tlsEnabled" .) }}

3. DNS over TLS (DoT)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   DoT å·²å¯ç”¨ï¼Œç«¯å£: {{ .Values.listeners.dot.port }}

   # ä½¿ç”¨ kdig æµ‹è¯•
   kdig +tls @$DNS_IP -p {{ .Values.listeners.dot.port }} example.com

   # æˆ–ä½¿ç”¨ dog
   dog --tls @$DNS_IP:{{ .Values.listeners.dot.port }} example.com

{{- end }}

{{- if and .Values.listeners.doh.enabled (include "dnsdist.tlsEnabled" .) }}

4. DNS over HTTPS (DoH)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   DoH å·²å¯ç”¨ï¼Œç«¯å£: {{ .Values.listeners.doh.port }}ï¼Œè·¯å¾„: {{ .Values.listeners.doh.path }}

   # JSON æ ¼å¼æŸ¥è¯¢
   curl -s -H "accept: application/dns-json" \
     "https://$DNS_IP:{{ .Values.listeners.doh.port }}{{ .Values.listeners.doh.path }}?name=example.com&type=A"

   # ä½¿ç”¨ dog
   dog --https @https://$DNS_IP:{{ .Values.listeners.doh.port }}{{ .Values.listeners.doh.path }} example.com

{{- end }}

{{- if and .Values.listeners.doq.enabled (include "dnsdist.tlsEnabled" .) }}

5. DNS over QUIC (DoQ)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   DoQ å·²å¯ç”¨ï¼Œç«¯å£: {{ .Values.listeners.doq.port }}

   # ä½¿ç”¨æ”¯æŒ DoQ çš„å®¢æˆ·ç«¯æµ‹è¯•
   q @quic://$DNS_IP:{{ .Values.listeners.doq.port }} example.com

{{- end }}

{{- if .Values.webserver.enabled }}

6. API ä¸ç›‘æ§
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   API Service (ä»…é›†ç¾¤å†…éƒ¨è®¿é—®):

   export API_IP=$(kubectl get svc --namespace {{ include "common.names.namespace" . }} {{ include "common.names.fullname" . }}-api \
     -o jsonpath='{.spec.clusterIP}')

   # å¥åº·æ£€æŸ¥
   curl http://$API_IP:{{ .Values.webserver.port }}/

   # Prometheus æŒ‡æ ‡
   curl http://$API_IP:{{ .Values.webserver.port }}/metrics

   # ç»Ÿè®¡ä¿¡æ¯
   curl http://$API_IP:{{ .Values.webserver.port }}/jsonstat

{{- end }}

{{- if .Values.console.enabled }}

7. ç®¡ç†æ§åˆ¶å°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

   è¿›å…¥ DNSdist æ§åˆ¶å°:

   kubectl exec -it --namespace {{ include "common.names.namespace" . }} \
     $(kubectl get pods --namespace {{ include "common.names.namespace" . }} \
       -l "app.kubernetes.io/name={{ include "common.names.name" . }},app.kubernetes.io/instance={{ .Release.Name }}" \
       -o jsonpath='{.items[0].metadata.name}') \
     -- dnsdist -c

   å¸¸ç”¨æ§åˆ¶å°å‘½ä»¤:
     showServers()        - æ˜¾ç¤ºåç«¯æœåŠ¡å™¨çŠ¶æ€
     showBinds()          - æ˜¾ç¤ºç›‘å¬åœ°å€
     showRules()          - æ˜¾ç¤ºè·¯ç”±è§„åˆ™
     topQueries(20)       - æ˜¾ç¤ºçƒ­é—¨æŸ¥è¯¢
     showCacheStats()     - æ˜¾ç¤ºç¼“å­˜ç»Ÿè®¡
     showResponseLatency()- æ˜¾ç¤ºå“åº”å»¶è¿Ÿ

{{- end }}

-------------------------------------------------------------------------------
 é‡è¦æç¤º
-------------------------------------------------------------------------------

{{- $warnings := list }}

{{- if not (include "dnsdist.tlsEnabled" .) }}
{{- if or .Values.listeners.dot.enabled .Values.listeners.doh.enabled .Values.listeners.doq.enabled .Values.listeners.doh3.enabled }}
{{- $warnings = append $warnings "tls" }}
{{- end }}
{{- end }}

{{- if not .Values.backends.recursor.enabled }}
{{- if not .Values.backends.auth.enabled }}
{{- if not .Values.backends.external.enabled }}
{{- $warnings = append $warnings "backend" }}
{{- end }}
{{- end }}
{{- end }}

{{- if has "tls" $warnings }}

âš ï¸  TLS è¯ä¹¦æœªé…ç½®

   åŠ å¯† DNS ç›‘å¬å™¨ (DoT/DoH/DoQ/DoH3) å·²å¯ç”¨ï¼Œä½† TLS è¯ä¹¦æœªé…ç½®ã€‚
   è¿™äº›ç›‘å¬å™¨å°†æ— æ³•æ­£å¸¸å·¥ä½œã€‚

   é…ç½® TLS è¯ä¹¦:

   # æ–¹å¼ 1: ä½¿ç”¨å·²æœ‰ Secret
   helm upgrade {{ .Release.Name }} {{ .Chart.Name }} \
     --namespace {{ include "common.names.namespace" . }} \
     --set tls.existingSecret=my-tls-secret

   # æ–¹å¼ 2: å†…è”è¯ä¹¦
   helm upgrade {{ .Release.Name }} {{ .Chart.Name }} \
     --namespace {{ include "common.names.namespace" . }} \
     --set-file tls.cert=./tls.crt \
     --set-file tls.key=./tls.key

{{- end }}

{{- if has "backend" $warnings }}

âš ï¸  åç«¯æœåŠ¡å™¨æœªé…ç½®

   DNSdist éœ€è¦è‡³å°‘ä¸€ä¸ªåç«¯ DNS æœåŠ¡å™¨æ‰èƒ½æ­£å¸¸å·¥ä½œã€‚

   é…ç½®åç«¯æœåŠ¡å™¨:

   helm upgrade {{ .Release.Name }} {{ .Chart.Name }} \
     --namespace {{ include "common.names.namespace" . }} \
     --set backends.recursor.enabled=true \
     --set backends.recursor.servers[0].name=recursor \
     --set backends.recursor.servers[0].address=your-dns-server \
     --set backends.recursor.servers[0].port=53

{{- end }}

{{- if not $warnings }}

âœ… é…ç½®æ£€æŸ¥é€šè¿‡

{{- end }}

-------------------------------------------------------------------------------
 æ›´å¤šä¿¡æ¯
-------------------------------------------------------------------------------

   ğŸ“– æ–‡æ¡£: https://dnsdist.org/
   ğŸ“¦ Chart: {{ .Chart.Name }} v{{ .Chart.Version }}
   ğŸ³ é•œåƒ: {{ .Values.image.repository }}:{{ .Values.image.tag }}

{{- end }}
