# PowerDNS Auth - 高性能 GeoDNS 配置示例
# 适用于百万级域名、每域名 1000+ 地区映射的大规模 GeoDNS 场景
#
# 使用方法:
#   helm install pdns-auth ./powerdns-auth -f examples/values-geodns-highperf.yaml
#
# 前置要求:
#   1. PostgreSQL 数据库已就绪
#   2. GeoIP 数据库 PVC 已创建并包含 MaxMind mmdb 文件
#   3. 足够的 CPU/内存资源

## 副本数量 - 根据 QPS 需求调整
## 建议: 10k QPS = 2-3 副本, 50k QPS = 5-8 副本, 100k+ QPS = 10+ 副本
replicaCount: 5

## 镜像配置
image:
  registry: docker.io
  repository: powerdns/pdns-auth-50
  tag: 5.0.2
  pullPolicy: IfNotPresent

## Pod 配置
podAntiAffinityPreset: hard  # 强制分散到不同节点

## 资源配置 - 大规模 GeoDNS 需要充足资源
resources:
  requests:
    cpu: "2"
    memory: "2Gi"
  limits:
    cpu: "4"
    memory: "4Gi"

## 核心配置
config:
  localAddress: "0.0.0.0, ::"
  localPort: 53
  loglevel: 3  # 生产环境降低日志级别
  logDnsDetails: false
  logDnsQueries: false  # 高 QPS 时必须关闭
  queryLogging: false
  
  ## 性能调优 - 关键配置
  performance:
    ## 接收线程数 = CPU 核心数或更多
    receiverThreads: 8
    ## 分发线程数
    distributorThreads: 2
    ## 签名线程数 (DNSSEC)
    signingThreads: 4
    ## SO_REUSEPORT - 多副本必须启用
    reuseport: true
    ## UDP 截断阈值
    udpTruncationThreshold: 1232
  
  ## TCP 配置
  maxTcpConnectionDuration: 0
  maxTcpConnections: 100
  tcpFastOpen: 128
  
  ## 缓存配置 - 对性能影响巨大
  cache:
    ## 包缓存 TTL (秒) - 相同查询直接返回缓存
    ttl: 30
    ## 否定缓存 TTL
    negTtl: 60
    ## 启用查询缓存
    queryEnabled: true
    ## 查询缓存 TTL
    queryTtl: 20
  
  ## LUA Records 配置 - GeoDNS 核心
  luaRecords:
    enabled: true
    
    ## GeoIP 数据库文件路径
    ## 需要通过 geoipVolume 挂载这些文件
    geoipDatabaseFiles:
      - /usr/share/GeoIP/GeoLite2-City.mmdb
      - /usr/share/GeoIP/GeoLite2-Country.mmdb
      - /usr/share/GeoIP/GeoLite2-ASN.mmdb
    
    ## EDNS Client Subnet - 必须启用！
    ## 这是 GeoDNS 准确性的关键，允许获取真实客户端 IP
    ednsSubnetProcessing: true
    
    ## Lua 执行限制 - 防止复杂脚本阻塞
    execLimit: 5000
    
    ## 健康检查配置 - 性能关键
    healthChecks:
      enabled: true
      ## 检查间隔 (秒) - 越小故障切换越快
      interval: 5
      ## 结果缓存时间 (秒) - 避免每次查询都检查
      expireDelay: 3600
      ## 最大并发检查数
      maxConcurrent: 32
      ## 检查超时 (毫秒)
      timeout: 2000
    
    ## AXFR 格式
    axfrFormat: "native"
  
  ## DNSSEC 配置
  defaultKskAlgorithm: "ecdsa256"
  defaultKskSize: 0
  defaultZskAlgorithm: ""
  defaultZskSize: 0
  
  ## 安全配置
  versionString: "anonymous"
  securityPollSuffix: ""
  
  ## 额外配置
  extra: {}

## 数据库配置 - 使用 PostgreSQL 获得最佳性能
database:
  type: postgresql
  postgresql:
    host: postgresql.database.svc.cluster.local
    port: 5432
    database: pdns
    username: pdns
    password: ""  # 使用 existingSecret
  ## 使用已有 Secret
  existingSecret:
    enabled: true
    name: pdns-db-credentials
    keys:
      host: host
      port: port
      database: database
      username: username
      password: password

## GeoIP 数据库挂载配置
## 使用独立的 geoip-database chart 管理数据库
## 先部署: helm install geoip-database fivetime/geoip-database -n kube-infra
geoipVolume:
  enabled: true
  existingClaim: geoip-database-data  # 来自 geoip-database chart

## 不使用 GeoIP Backend (我们使用 LUA Records)
geoip:
  enabled: false

## Webserver/API 配置
webserver:
  enabled: true
  port: 8081
  address: "0.0.0.0"
  allowFrom: "10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
  apiKey: ""  # 使用 existingSecret

## Service 配置
service:
  type: LoadBalancer
  dns:
    port: 53
    protocol: UDP
  dnsTcp:
    enabled: true
    port: 53
    protocol: TCP
  api:
    enabled: true
    port: 8081
  ## 会话亲和性 - GeoDNS 场景建议关闭
  sessionAffinity: None
  ## 外部流量策略
  externalTrafficPolicy: Local  # 保留客户端 IP

## 探针配置
startupProbe:
  enabled: true
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 30

livenessProbe:
  enabled: true
  initialDelaySeconds: 30
  periodSeconds: 20
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  enabled: true
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

## 自动扩缩容
autoscaling:
  hpa:
    enabled: true
    minReplicas: 3
    maxReplicas: 20
    targetCPU: 70
    targetMemory: 80
  vpa:
    enabled: false

## Pod 中断预算
pdb:
  create: true
  minAvailable: 2

## 网络策略
networkPolicy:
  enabled: true
  allowExternal: true
  allowExternalEgress: true

## 监控
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    interval: 15s

## 安全上下文
podSecurityContext:
  enabled: true
  fsGroup: 953

containerSecurityContext:
  enabled: true
  runAsUser: 953
  runAsGroup: 953
  runAsNonRoot: true
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

## 节点选择 - 建议部署到专用节点
nodeSelector: {}
  # node-type: dns

## 容忍度
tolerations: []

## 亲和性
affinity: {}

## 拓扑分布约束 - 跨可用区分布
topologySpreadConstraints:
  - maxSkew: 1
    topologyKey: topology.kubernetes.io/zone
    whenUnsatisfiable: ScheduleAnyway
    labelSelector:
      matchLabels:
        app.kubernetes.io/name: powerdns-auth
