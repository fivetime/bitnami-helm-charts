# 手动清理旧版本 Helm Charts
# 保留每个 chart 的最新 1 个版本

name: Cleanup Old Charts

on:
  workflow_dispatch:
    inputs:
      chart_name:
        description: 'Chart 名称 (留空则清理所有 charts)'
        required: false
        default: ''
      dry_run:
        description: '仅预览，不实际删除'
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Delete old releases
        uses: actions/github-script@v7
        with:
          script: |
            const chartFilter = '${{ inputs.chart_name }}';
            const dryRun = ${{ inputs.dry_run }};
            const keepCount = 1;
            
            console.log(`Mode: ${dryRun ? 'DRY RUN (预览)' : 'REAL DELETE (实际删除)'}`);
            console.log(`Filter: ${chartFilter || 'all charts'}`);
            console.log(`Keep: ${keepCount} version(s) per chart\n`);
            
            // 获取所有 releases
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // 按 chart 名称分组
            const chartGroups = {};
            for (const release of releases.data) {
              // tag 格式: chartname-1.2.3
              const match = release.tag_name.match(/^(.+)-(\d+\.\d+\.\d+.*)$/);
              if (!match) continue;
              
              const [, chartName, version] = match;
              
              // 如果指定了 chart，只处理该 chart
              if (chartFilter && chartName !== chartFilter) continue;
              
              if (!chartGroups[chartName]) {
                chartGroups[chartName] = [];
              }
              chartGroups[chartName].push(release);
            }
            
            // 处理每个 chart
            let totalDeleted = 0;
            for (const [chartName, chartReleases] of Object.entries(chartGroups)) {
              // 按创建时间排序（新的在前）
              chartReleases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              
              const toDelete = chartReleases.slice(keepCount);
              if (toDelete.length === 0) {
                console.log(`✓ ${chartName}: 只有 ${chartReleases.length} 个版本，无需清理`);
                continue;
              }
              
              console.log(`\n${chartName}: 共 ${chartReleases.length} 个版本，将删除 ${toDelete.length} 个旧版本`);
              console.log(`  保留: ${chartReleases.slice(0, keepCount).map(r => r.tag_name).join(', ')}`);
              
              for (const release of toDelete) {
                console.log(`  删除: ${release.tag_name}`);
                
                if (!dryRun) {
                  // 删除 release
                  await github.rest.repos.deleteRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.id
                  });
                  
                  // 删除对应的 tag
                  try {
                    await github.rest.git.deleteRef({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      ref: `tags/${release.tag_name}`
                    });
                  } catch (e) {
                    console.log(`    (tag 删除失败: ${e.message})`);
                  }
                  
                  totalDeleted++;
                }
              }
            }
            
            if (dryRun) {
              console.log('\n⚠️  DRY RUN 模式，未实际删除任何内容');
              console.log('如需实际删除，请将 dry_run 设为 false 重新运行');
            } else {
              console.log(`\n✓ 已删除 ${totalDeleted} 个旧版本`);
            }

      - name: Rebuild index.yaml from releases
        if: ${{ inputs.dry_run == false }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          
          # 创建临时目录存放 chart 包
          mkdir -p .charts
          
          # 获取所有 releases 并下载 chart 包
          echo "下载所有 chart 包..."
          gh release list --limit 200 --json tagName,assets -q '.[] | select(.assets | length > 0) | .assets[].url' | while read url; do
            if [[ "$url" == *.tgz ]]; then
              echo "  下载: $(basename $url)"
              curl -sSL -o ".charts/$(basename $url)" "$url"
            fi
          done
          
          # 统计下载的包
          count=$(ls -1 .charts/*.tgz 2>/dev/null | wc -l)
          echo "共下载 $count 个 chart 包"
          
          if [ "$count" -eq 0 ]; then
            echo "没有找到 chart 包，跳过"
            exit 0
          fi
          
          # 生成新的 index.yaml
          echo "生成 index.yaml..."
          helm repo index .charts --url https://github.com/fivetime/bitnami-helm-charts/releases/download
          
          # 替换旧的 index.yaml
          mv .charts/index.yaml index.yaml
          
          # 提交更改
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.yaml
          
          if git diff --cached --quiet; then
            echo "index.yaml 无变化"
          else
            git commit -m "Rebuild index.yaml from releases"
            git push
            echo "✓ index.yaml 已重新生成并推送"
          fi
