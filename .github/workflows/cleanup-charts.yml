# 手动清理旧版本 Helm Charts
# 保留每个 chart 的最新 1 个版本

name: Cleanup Old Charts

on:
  workflow_dispatch:
    inputs:
      chart_name:
        description: 'Chart 名称 (留空则清理所有 charts)'
        required: false
        default: ''
      dry_run:
        description: '仅预览，不实际删除'
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Delete old releases
        uses: actions/github-script@v7
        with:
          script: |
            const chartFilter = '${{ inputs.chart_name }}';
            const dryRun = ${{ inputs.dry_run }};
            const keepCount = 1;
            
            console.log(`Mode: ${dryRun ? 'DRY RUN (预览)' : 'REAL DELETE (实际删除)'}`);
            console.log(`Filter: ${chartFilter || 'all charts'}`);
            console.log(`Keep: ${keepCount} version(s) per chart\n`);
            
            // 获取所有 releases
            const releases = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            // 按 chart 名称分组
            const chartGroups = {};
            for (const release of releases.data) {
              // tag 格式: chartname-1.2.3
              const match = release.tag_name.match(/^(.+)-(\d+\.\d+\.\d+.*)$/);
              if (!match) continue;
              
              const [, chartName, version] = match;
              
              // 如果指定了 chart，只处理该 chart
              if (chartFilter && chartName !== chartFilter) continue;
              
              if (!chartGroups[chartName]) {
                chartGroups[chartName] = [];
              }
              chartGroups[chartName].push(release);
            }
            
            // 处理每个 chart
            let totalDeleted = 0;
            for (const [chartName, chartReleases] of Object.entries(chartGroups)) {
              // 按创建时间排序（新的在前）
              chartReleases.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
              
              const toDelete = chartReleases.slice(keepCount);
              if (toDelete.length === 0) {
                console.log(`✓ ${chartName}: 只有 ${chartReleases.length} 个版本，无需清理`);
                continue;
              }
              
              console.log(`\n${chartName}: 共 ${chartReleases.length} 个版本，将删除 ${toDelete.length} 个旧版本`);
              console.log(`  保留: ${chartReleases.slice(0, keepCount).map(r => r.tag_name).join(', ')}`);
              
              for (const release of toDelete) {
                console.log(`  删除: ${release.tag_name}`);
                
                if (!dryRun) {
                  // 删除 release
                  await github.rest.repos.deleteRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.id
                  });
                  
                  // 删除对应的 tag
                  try {
                    await github.rest.git.deleteRef({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      ref: `tags/${release.tag_name}`
                    });
                  } catch (e) {
                    console.log(`    (tag 删除失败: ${e.message})`);
                  }
                  
                  totalDeleted++;
                }
              }
            }
            
            if (dryRun) {
              console.log('\n⚠️  DRY RUN 模式，未实际删除任何内容');
              console.log('如需实际删除，请将 dry_run 设为 false 重新运行');
            } else {
              console.log(`\n✓ 已删除 ${totalDeleted} 个旧版本`);
            }

      - name: Rebuild index.yaml
        if: ${{ inputs.dry_run == false }}
        env:
          CR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 安装 chart-releaser
          curl -sSLo cr.tar.gz https://github.com/helm/chart-releaser/releases/download/v1.6.0/chart-releaser_1.6.0_linux_amd64.tar.gz
          tar -xzf cr.tar.gz cr
          chmod +x cr
          
          # 清空旧的 index.yaml
          rm -f index.yaml
          
          # 重新生成 index.yaml
          ./cr index \
            --owner fivetime \
            --git-repo bitnami-helm-charts \
            --pages-branch gh-pages \
            --token "$CR_TOKEN" \
            --push
          
          echo "✓ index.yaml 已重新生成"
