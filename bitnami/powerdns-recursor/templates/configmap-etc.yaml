{{/*
Copyright Anthropic, Inc. or its affiliates. All Rights Reserved.
SPDX-License-Identifier: Apache-2.0
*/}}

apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ printf "%s-etc" (include "common.names.fullname" .) }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
    app.kubernetes.io/component: recursor
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
data:
  recursor.yml: |
    #
    # PowerDNS Recursor Configuration (YAML format)
    # Generated by Helm - PowerDNS Recursor {{ .Values.image.tag }}
    #

    ######### SECTION incoming #########
    incoming:
      listen:
{{ toYaml .Values.config.incoming.listen | indent 8 }}
      port: {{ .Values.config.incoming.port }}
      allow_from:
{{ toYaml .Values.config.incoming.allowFrom | indent 8 }}
      allow_no_rd: {{ .Values.config.incoming.allowNoRd }}
      tcp_fast_open: {{ .Values.config.incoming.tcpFastOpen }}
      reuseport: {{ .Values.config.incoming.reuseport }}
      {{- if .Values.config.incoming.proxyProtocolFrom }}
      proxy_protocol_from:
{{ toYaml .Values.config.incoming.proxyProtocolFrom | indent 8 }}
      {{- end }}
      {{- if .Values.config.incoming.proxyProtocolExceptions }}
      proxy_protocol_exceptions:
{{ toYaml .Values.config.incoming.proxyProtocolExceptions | indent 8 }}
      {{- end }}
      {{- if .Values.config.incoming.allowNotifyFrom }}
      allow_notify_from:
{{ toYaml .Values.config.incoming.allowNotifyFrom | indent 8 }}
      {{- end }}
      {{- if .Values.config.incoming.allowNotifyFor }}
      allow_notify_for:
{{ toYaml .Values.config.incoming.allowNotifyFor | indent 8 }}
      {{- end }}

    ######### SECTION recursor #########
    recursor:
      threads: {{ .Values.config.recursor.threads }}
      pdns_distributes_queries: {{ .Values.config.recursor.pdnsDistributesQueries }}
      socket_dir: {{ .Values.config.recursor.socketDir | quote }}
      version_string: {{ .Values.config.recursor.versionString | quote }}
      daemon: {{ .Values.config.recursor.daemon }}
      write_pid: {{ .Values.config.recursor.writePid }}
      {{- if .Values.config.recursor.extendedResolutionErrors }}
      extended_resolution_errors: {{ .Values.config.recursor.extendedResolutionErrors }}
      {{- end }}
      {{- if .Values.config.recursor.securityPollSuffix }}
      security_poll_suffix: {{ .Values.config.recursor.securityPollSuffix | quote }}
      {{- else }}
      security_poll_suffix: ""
      {{- end }}
      {{- if include "powerdns-recursor.luaConfigEnabled" . }}
      lua_config_file: "/etc/pdns-recursor/config.lua"
      {{- end }}
      {{- if include "powerdns-recursor.luaDnsEnabled" . }}
      lua_dns_script: "/etc/pdns-recursor/dns.lua"
      {{- end }}
      {{- /* Check if there are any non-recursive forward zones */ -}}
      {{- $hasNonRecursiveZones := false }}
      {{- range .Values.forwardZones.zones }}
        {{- if not .recurse }}
          {{- $hasNonRecursiveZones = true }}
        {{- end }}
      {{- end }}
      {{- if $hasNonRecursiveZones }}
      forward_zones:
        {{- range .Values.forwardZones.zones }}
        {{- if not .recurse }}
        - zone: {{ .zone }}
          forwarders:
{{ toYaml .forwarders | indent 12 }}
        {{- end }}
        {{- end }}
      {{- end }}
      {{- /* Check if there are any recursive zones to output */ -}}
      {{- $hasRecursiveZones := gt (len .Values.forwardZones.recursiveZones) 0 }}
      {{- range .Values.forwardZones.zones }}
        {{- if .recurse }}
          {{- $hasRecursiveZones = true }}
        {{- end }}
      {{- end }}
      {{- if $hasRecursiveZones }}
      forward_zones_recurse:
        {{- range .Values.forwardZones.recursiveZones }}
        - zone: {{ .zone }}
          forwarders:
{{ toYaml .forwarders | indent 12 }}
        {{- end }}
        {{- range .Values.forwardZones.zones }}
        {{- if .recurse }}
        - zone: {{ .zone }}
          forwarders:
{{ toYaml .forwarders | indent 12 }}
        {{- end }}
        {{- end }}
      {{- end }}
      {{- if .Values.config.recursor.sortlists }}
      sortlists:
{{ toYaml .Values.config.recursor.sortlists | indent 8 }}
      {{- end }}

    {{- if and .Values.config.dns64 .Values.config.dns64.prefix }}
    ######### SECTION dns64 #########
    dns64:
      prefix: {{ .Values.config.dns64.prefix | quote }}
    {{- end }}

    ######### SECTION dnssec #########
    dnssec:
      validation: {{ .Values.config.dnssec.validation | quote }}
      log_bogus: {{ .Values.config.dnssec.logBogus }}
      aggressive_nsec_cache_size: {{ .Values.config.dnssec.aggressiveNsecCacheSize | int64 }}
      {{- if .Values.config.dnssec.aggressiveCacheMinNsec3HitRatio }}
      aggressive_cache_min_nsec3_hit_ratio: {{ .Values.config.dnssec.aggressiveCacheMinNsec3HitRatio }}
      {{- end }}
      {{- if .Values.config.dnssec.nsec3MaxIterations }}
      nsec3_max_iterations: {{ .Values.config.dnssec.nsec3MaxIterations }}
      {{- end }}
      {{- if .Values.config.dnssec.signatureInceptionSkew }}
      signature_inception_skew: {{ .Values.config.dnssec.signatureInceptionSkew }}
      {{- end }}
      {{- if .Values.config.dnssec.disabledAlgorithms }}
      disabled_algorithms:
{{ toYaml .Values.config.dnssec.disabledAlgorithms | indent 8 }}
      {{- end }}
      {{- if .Values.config.dnssec.maxDnskeys }}
      max_dnskeys: {{ .Values.config.dnssec.maxDnskeys }}
      {{- end }}
      {{- if .Values.config.dnssec.maxDsPerZone }}
      max_ds_per_zone: {{ .Values.config.dnssec.maxDsPerZone }}
      {{- end }}
      {{- if .Values.config.dnssec.maxRrsigsPerRecord }}
      max_rrsigs_per_record: {{ .Values.config.dnssec.maxRrsigsPerRecord }}
      {{- end }}
      {{- if .Values.config.dnssec.maxNsec3sPerRecord }}
      max_nsec3s_per_record: {{ .Values.config.dnssec.maxNsec3sPerRecord }}
      {{- end }}
      {{- if .Values.config.dnssec.maxSignatureValidationsPerQuery }}
      max_signature_validations_per_query: {{ .Values.config.dnssec.maxSignatureValidationsPerQuery }}
      {{- end }}
      {{- if .Values.config.dnssec.maxNsec3HashComputationsPerQuery }}
      max_nsec3_hash_computations_per_query: {{ .Values.config.dnssec.maxNsec3HashComputationsPerQuery }}
      {{- end }}

    ######### SECTION logging #########
    logging:
      loglevel: {{ .Values.config.logging.loglevel }}
      common_errors: {{ .Values.config.logging.commonErrors }}
      disable_syslog: {{ .Values.config.logging.disableSyslog }}
      quiet: {{ .Values.config.logging.quiet }}
      trace: {{ .Values.config.logging.trace | quote }}
      timestamp: {{ .Values.config.logging.timestamp }}
      structured_logging: {{ .Values.config.logging.structuredLogging }}
      {{- if .Values.config.logging.protobufServers }}
      protobuf_servers:
{{ toYaml .Values.config.logging.protobufServers | indent 8 }}
      {{- end }}
      {{- if .Values.config.logging.outgoingProtobufServers }}
      outgoing_protobuf_servers:
{{ toYaml .Values.config.logging.outgoingProtobufServers | indent 8 }}
      {{- end }}
      {{- if .Values.config.logging.protobufMaskV4 }}
      protobuf_mask_v4: {{ .Values.config.logging.protobufMaskV4 }}
      {{- end }}
      {{- if .Values.config.logging.protobufMaskV6 }}
      protobuf_mask_v6: {{ .Values.config.logging.protobufMaskV6 }}
      {{- end }}
      {{- if and .Values.config.logging.protobufServers (ne .Values.config.logging.protobufLogQueries nil) }}
      protobuf_log_queries: {{ .Values.config.logging.protobufLogQueries }}
      {{- end }}
      {{- if and .Values.config.logging.protobufServers (ne .Values.config.logging.protobufLogResponses nil) }}
      protobuf_log_responses: {{ .Values.config.logging.protobufLogResponses }}
      {{- end }}
      {{- if and .Values.config.logging.protobufServers .Values.config.logging.protobufAlwaysCache }}
      protobuf_always_cache: {{ .Values.config.logging.protobufAlwaysCache }}
      {{- end }}
      {{- if and .Values.config.logging.protobufServers .Values.config.logging.protobufTaggedOnly }}
      protobuf_tagged_only: {{ .Values.config.logging.protobufTaggedOnly }}
      {{- end }}
      {{- if .Values.config.logging.dnstapFramestreamServers }}
      dnstap_framestream_servers:
{{ toYaml .Values.config.logging.dnstapFramestreamServers | indent 8 }}
      {{- end }}
      {{- if and .Values.config.logging.dnstapFramestreamServers (ne .Values.config.logging.dnstapLogQueries nil) }}
      dnstap_log_queries: {{ .Values.config.logging.dnstapLogQueries }}
      {{- end }}
      {{- if and .Values.config.logging.dnstapFramestreamServers (ne .Values.config.logging.dnstapLogResponses nil) }}
      dnstap_log_responses: {{ .Values.config.logging.dnstapLogResponses }}
      {{- end }}
      {{- if and .Values.config.logging.dnstapFramestreamServers .Values.config.logging.dnstapIdentity }}
      dnstap_identity: {{ .Values.config.logging.dnstapIdentity | quote }}
      {{- end }}

    ######### SECTION webservice #########
    {{- if .Values.webserver.enabled }}
    webservice:
      webserver: true
      address: {{ .Values.webserver.address | quote }}
      port: {{ .Values.webserver.port }}
      allow_from:
{{ toYaml .Values.webserver.allowFrom | indent 8 }}
      {{- if and .Values.webserver.password (not .Values.webserver.existingSecret) }}
      password: {{ .Values.webserver.password | quote }}
      {{- end }}
      {{- if and .Values.webserver.apiKey (not .Values.webserver.existingSecret) }}
      api_key: {{ .Values.webserver.apiKey | quote }}
      {{- end }}
    {{- end }}

    ######### SECTION ecs #########
    ecs:
      add_for:
{{ toYaml .Values.config.ecs.addFor | indent 8 }}
      ipv4_bits: {{ .Values.config.ecs.ipv4Bits }}
      ipv6_bits: {{ .Values.config.ecs.ipv6Bits }}

    ######### SECTION outgoing #########
    {{- if .Values.config.outgoing }}
    outgoing:
      {{- if .Values.config.outgoing.dontQuery }}
      dont_query:
{{ toYaml .Values.config.outgoing.dontQuery | indent 8 }}
      {{- end }}
      {{- if .Values.config.outgoing.sourceAddress }}
      source_address:
{{ toYaml .Values.config.outgoing.sourceAddress | indent 8 }}
      {{- end }}
      {{- if .Values.config.outgoing.networkTimeout }}
      network_timeout: {{ .Values.config.outgoing.networkTimeout }}
      {{- end }}
      {{- if .Values.config.outgoing.tcpFastOpenConnect }}
      tcp_fast_open_connect: {{ .Values.config.outgoing.tcpFastOpenConnect }}
      {{- end }}
      {{- if .Values.config.outgoing.ednsSubnetAllowList }}
      edns_subnet_allow_list:
{{ toYaml .Values.config.outgoing.ednsSubnetAllowList | indent 8 }}
      {{- end }}
      {{- if .Values.config.outgoing.ednsSubnetHarden }}
      edns_subnet_harden: {{ .Values.config.outgoing.ednsSubnetHarden }}
      {{- end }}
      {{- if .Values.config.outgoing.dontThrottleNames }}
      dont_throttle_names:
{{ toYaml .Values.config.outgoing.dontThrottleNames | indent 8 }}
      {{- end }}
      {{- if .Values.config.outgoing.dontThrottleNetmasks }}
      dont_throttle_netmasks:
{{ toYaml .Values.config.outgoing.dontThrottleNetmasks | indent 8 }}
      {{- end }}
      {{- if .Values.config.outgoing.maxQperq }}
      max_qperq: {{ .Values.config.outgoing.maxQperq }}
      {{- end }}
      {{- if .Values.config.outgoing.maxNsAddressQperq }}
      max_ns_address_qperq: {{ .Values.config.outgoing.maxNsAddressQperq }}
      {{- end }}
      {{- if .Values.config.outgoing.maxNsPerResolve }}
      max_ns_per_resolve: {{ .Values.config.outgoing.maxNsPerResolve }}
      {{- end }}
      {{- if .Values.config.outgoing.serverDownMaxFails }}
      server_down_max_fails: {{ .Values.config.outgoing.serverDownMaxFails }}
      {{- end }}
      {{- if .Values.config.outgoing.serverDownThrottleTime }}
      server_down_throttle_time: {{ .Values.config.outgoing.serverDownThrottleTime }}
      {{- end }}
      {{- if .Values.config.outgoing.udpSourcePortMin }}
      udp_source_port_min: {{ .Values.config.outgoing.udpSourcePortMin }}
      {{- end }}
      {{- if .Values.config.outgoing.udpSourcePortMax }}
      udp_source_port_max: {{ .Values.config.outgoing.udpSourcePortMax }}
      {{- end }}
      {{- if .Values.config.outgoing.udpSourcePortAvoid }}
      udp_source_port_avoid:
{{ toYaml .Values.config.outgoing.udpSourcePortAvoid | indent 8 }}
      {{- end }}
      {{- if .Values.config.outgoing.dotToAuthNames }}
      dot_to_auth_names:
{{ toYaml .Values.config.outgoing.dotToAuthNames | indent 8 }}
      {{- end }}
      {{- if .Values.config.outgoing.dotToForwarders }}
      dot_to_forwarders: {{ .Values.config.outgoing.dotToForwarders }}
      {{- end }}
    {{- end }}

    ######### SECTION packetcache #########
    {{- if .Values.config.packetcache }}
    packetcache:
      {{- if .Values.config.packetcache.disable }}
      disable: {{ .Values.config.packetcache.disable }}
      {{- end }}
      {{- if .Values.config.packetcache.maxEntries }}
      max_entries: {{ .Values.config.packetcache.maxEntries }}
      {{- end }}
      {{- if .Values.config.packetcache.ttl }}
      ttl: {{ .Values.config.packetcache.ttl }}
      {{- end }}
      {{- if .Values.config.packetcache.negativeTtl }}
      negative_ttl: {{ .Values.config.packetcache.negativeTtl }}
      {{- end }}
      {{- if .Values.config.packetcache.servfailTtl }}
      servfail_ttl: {{ .Values.config.packetcache.servfailTtl }}
      {{- end }}
      {{- if .Values.config.packetcache.shards }}
      shards: {{ .Values.config.packetcache.shards }}
      {{- end }}
    {{- end }}

    ######### SECTION recordcache #########
    {{- if .Values.config.cache }}
    recordcache:
      {{- if .Values.config.cache.maxCacheEntries }}
      max_entries: {{ .Values.config.cache.maxCacheEntries | int64 }}
      {{- end }}
      {{- if .Values.config.cache.maxNegativeTtl }}
      max_negative_ttl: {{ .Values.config.cache.maxNegativeTtl }}
      {{- end }}
      {{- if .Values.config.cache.maxCacheTtl }}
      max_ttl: {{ .Values.config.cache.maxCacheTtl }}
      {{- end }}
      {{- if .Values.config.cache.servfailCacheTtl }}
      servfail_ttl: {{ .Values.config.cache.servfailCacheTtl }}
      {{- end }}
    {{- end }}

    ######### SECTION nod #########
    {{- if and .Values.config.nod .Values.config.nod.enabled }}
    nod:
      {{- if .Values.config.nod.tracking }}
      tracking: {{ .Values.config.nod.tracking }}
      {{- end }}
      {{- if .Values.config.nod.log }}
      log: {{ .Values.config.nod.log }}
      {{- end }}
      {{- if .Values.config.nod.lookup }}
      lookup: {{ .Values.config.nod.lookup | quote }}
      {{- end }}
      {{- if .Values.config.nod.dbSize }}
      db_size: {{ .Values.config.nod.dbSize | int64 }}
      {{- end }}
      {{- if .Values.config.nod.historyDir }}
      history_dir: {{ .Values.config.nod.historyDir | quote }}
      {{- end }}
      {{- if .Values.config.nod.ignoreList }}
      ignore_list:
{{ toYaml .Values.config.nod.ignoreList | indent 8 }}
      {{- end }}
      {{- if .Values.config.nod.pbTag }}
      pb_tag: {{ .Values.config.nod.pbTag | quote }}
      {{- end }}
      {{- if .Values.config.nod.uniqueResponseTracking }}
      unique_response_tracking: {{ .Values.config.nod.uniqueResponseTracking }}
      {{- end }}
      {{- if .Values.config.nod.uniqueResponseLog }}
      unique_response_log: {{ .Values.config.nod.uniqueResponseLog }}
      {{- end }}
      {{- if .Values.config.nod.uniqueResponseDbSize }}
      unique_response_db_size: {{ .Values.config.nod.uniqueResponseDbSize | int64 }}
      {{- end }}
      {{- if .Values.config.nod.uniqueResponseHistoryDir }}
      unique_response_history_dir: {{ .Values.config.nod.uniqueResponseHistoryDir | quote }}
      {{- end }}
      {{- if .Values.config.nod.uniqueResponsePbTag }}
      unique_response_pb_tag: {{ .Values.config.nod.uniqueResponsePbTag | quote }}
      {{- end }}
    {{- end }}

    ######### SECTION carbon #########
    {{- if and .Values.config.carbon .Values.config.carbon.enabled }}
    carbon:
      {{- if .Values.config.carbon.server }}
      server:
{{ toYaml .Values.config.carbon.server | indent 8 }}
      {{- end }}
      {{- if .Values.config.carbon.interval }}
      interval: {{ .Values.config.carbon.interval }}
      {{- end }}
      {{- if .Values.config.carbon.ourname }}
      ourname: {{ .Values.config.carbon.ourname | quote }}
      {{- end }}
      {{- if .Values.config.carbon.namespace }}
      ns: {{ .Values.config.carbon.namespace | quote }}
      {{- end }}
      {{- if .Values.config.carbon.instance }}
      instance: {{ .Values.config.carbon.instance | quote }}
      {{- end }}
    {{- end }}

    {{- if .Values.config.extraConfig }}
    ######### SECTION extra #########
{{ toYaml .Values.config.extraConfig | indent 4 }}
    {{- end }}
