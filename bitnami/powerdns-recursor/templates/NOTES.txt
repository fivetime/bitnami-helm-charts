CHART NAME: {{ .Chart.Name }}
CHART VERSION: {{ .Chart.Version }}
APP VERSION: {{ .Chart.AppVersion }}

** 请耐心等待，PowerDNS Recursor 正在部署中 **

{{- if .Values.diagnosticMode.enabled }}
诊断模式已启用。所有探针已禁用，命令已被覆盖。

获取 Pod 列表:
  kubectl get pods --namespace {{ include "common.names.namespace" . }} -l "app.kubernetes.io/name={{ include "common.names.name" . }},app.kubernetes.io/instance={{ .Release.Name }}"

进入容器进行调试:
  kubectl exec -it $(kubectl get pods -n {{ include "common.names.namespace" . }} -l "app.kubernetes.io/name={{ include "common.names.name" . }}" -o jsonpath='{.items[0].metadata.name}') -n {{ include "common.names.namespace" . }} -- bash

{{- else }}

1. 获取 PowerDNS Recursor DNS 地址:

{{- if eq .Values.service.type "ClusterIP" }}

  集群内访问:
    DNS_HOST={{ include "common.names.fullname" . }}.{{ include "common.names.namespace" . }}.svc.{{ .Values.clusterDomain }}
    DNS_PORT={{ .Values.service.ports.dns }}

  端口转发测试:
    kubectl port-forward --namespace {{ include "common.names.namespace" . }} svc/{{ include "common.names.fullname" . }} 5353:{{ .Values.service.ports.dns }}
    dig @127.0.0.1 -p 5353 example.com

{{- else if eq .Values.service.type "NodePort" }}

  export NODE_PORT=$(kubectl get --namespace {{ include "common.names.namespace" . }} -o jsonpath="{.spec.ports[0].nodePort}" services {{ include "common.names.fullname" . }})
  export NODE_IP=$(kubectl get nodes --namespace {{ include "common.names.namespace" . }} -o jsonpath="{.items[0].status.addresses[0].address}")
  echo "DNS 地址: $NODE_IP:$NODE_PORT"

{{- else if eq .Values.service.type "LoadBalancer" }}

  注意: LoadBalancer IP 获取可能需要几分钟

  export SERVICE_IP=$(kubectl get svc --namespace {{ include "common.names.namespace" . }} {{ include "common.names.fullname" . }} --template "{{"{{ range (index .status.loadBalancer.ingress 0) }}{{.}}{{ end }}"}}")
  echo "DNS 地址: $SERVICE_IP:{{ .Values.service.ports.dns }}"

{{- end }}

2. DNS 查询测试:

  # 查询外部域名
  dig @<DNS_HOST> -p <DNS_PORT> google.com

  # 查询 DNSSEC 验证
  dig @<DNS_HOST> -p <DNS_PORT> dnssec-failed.org +dnssec

{{- if .Values.webserver.enabled }}

3. 访问 Web API:

{{- if .Values.ingress.enabled }}

  API URL: http{{ if .Values.ingress.tls }}s{{ end }}://{{ .Values.ingress.hostname }}{{ .Values.ingress.path }}

{{- else }}

  kubectl port-forward --namespace {{ include "common.names.namespace" . }} svc/{{ include "common.names.fullname" . }} 8082:{{ .Values.service.ports.webserver }}
  
  # 获取统计信息
  curl http://127.0.0.1:8082/api/v1/servers/localhost/statistics

  # 获取配置
  curl http://127.0.0.1:8082/api/v1/servers/localhost/config

{{- end }}
{{- end }}

{{- if .Values.forwardZones.zones }}

4. 已配置的转发区域:
{{- range .Values.forwardZones.zones }}
  - {{ .zone }} -> {{ .forwarders | join ", " }}
{{- end }}
{{- end }}

{{- if .Values.forwardZones.recursiveZones }}

5. 已配置的递归转发区域:
{{- range .Values.forwardZones.recursiveZones }}
  - {{ .zone }} -> {{ .forwarders | join ", " }}
{{- end }}
{{- end }}

{{- if .Values.trustAnchors.enabled }}

6. 已配置的 DNSSEC 信任锚点:
{{- range .Values.trustAnchors.anchors }}
  - {{ .zone }}
{{- end }}
{{- end }}

{{- if .Values.rpz.enabled }}

7. 已启用 RPZ (Response Policy Zones):
{{- range .Values.rpz.zones }}
  - {{ .name }}
{{- end }}
{{- end }}

{{- if .Values.metrics.enabled }}

8. Prometheus 指标:

  指标端点: http://<SERVICE_IP>:{{ .Values.webserver.port }}/metrics

{{- if .Values.metrics.serviceMonitor.enabled }}
  ServiceMonitor 已创建，Prometheus Operator 将自动发现。
{{- end }}
{{- end }}

{{- end }}

更多信息请参阅 PowerDNS Recursor 文档: https://doc.powerdns.com/recursor/
