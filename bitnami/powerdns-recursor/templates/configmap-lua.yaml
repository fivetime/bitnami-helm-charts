{{/*
Copyright Anthropic, Inc. or its affiliates. All Rights Reserved.
SPDX-License-Identifier: Apache-2.0
*/}}

{{- if include "powerdns-recursor.luaEnabled" . }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ printf "%s-lua" (include "common.names.fullname" .) }}
  namespace: {{ include "common.names.namespace" . | quote }}
  labels: {{- include "common.labels.standard" ( dict "customLabels" .Values.commonLabels "context" $ ) | nindent 4 }}
    app.kubernetes.io/component: recursor
  {{- if .Values.commonAnnotations }}
  annotations: {{- include "common.tplvalues.render" ( dict "value" .Values.commonAnnotations "context" $ ) | nindent 4 }}
  {{- end }}
data:
  {{- if include "powerdns-recursor.luaConfigEnabled" . }}
  config.lua: |
    --[[
    PowerDNS Recursor Lua Configuration
    Generated by Helm
    --]]

    pdnslog("Loading Lua Configuration")

    {{- if .Values.trustAnchors.enabled }}
    -- ==========================================================================
    -- DNSSEC Trust Anchors for Private Zones
    -- ==========================================================================
    {{- range .Values.trustAnchors.anchors }}
    pdnslog("Adding trust anchor for {{ .zone }}")
    addTA("{{ .zone }}", "{{ .dsRecord }}")
    {{- end }}
    {{- end }}

    {{- if .Values.trustAnchors.negative }}
    -- ==========================================================================
    -- Negative Trust Anchors (disable DNSSEC validation)
    -- ==========================================================================
    {{- range .Values.trustAnchors.negative }}
    pdnslog("Adding negative trust anchor for {{ .zone }}: {{ .reason }}")
    addNTA("{{ .zone }}", "{{ .reason }}")
    {{- end }}
    {{- end }}

    {{- if .Values.rpz.enabled }}
    -- ==========================================================================
    -- RPZ (Response Policy Zones) Configuration
    -- ==========================================================================
    {{- range .Values.rpz.zones }}
    {{- if .url }}
    pdnslog("Loading RPZ zone: {{ .name }} from {{ .url }}")
    rpzFile("{{ .url }}", {
        policyName = "{{ .name }}",
        {{- if .refresh }}
        refresh = {{ .refresh }},
        {{- end }}
        {{- if .policy }}
        defpol = Policy.{{ .policy }},
        {{- end }}
    })
    {{- else if .file }}
    pdnslog("Loading RPZ zone: {{ .name }} from {{ .file }}")
    rpzFile("{{ .file }}", {
        policyName = "{{ .name }}",
        {{- if .policy }}
        defpol = Policy.{{ .policy }},
        {{- end }}
    })
    {{- end }}
    {{- end }}
    {{- end }}

    {{- if and .Values.zoneToCache .Values.zoneToCache.enabled .Values.zoneToCache.zones }}
    -- ==========================================================================
    -- Zone to Cache Configuration
    -- Preloads zones into the cache for improved performance
    -- ==========================================================================
    {{- range .Values.zoneToCache.zones }}
    pdnslog("Loading zone {{ .zone }} into cache via {{ .method }}")
    zoneToCache("{{ .zone }}", "{{ .method }}", "{{ .source }}", {
        {{- if .refreshPeriod }}
        refreshPeriod = {{ .refreshPeriod }},
        {{- end }}
        {{- if .retryOnError }}
        retryOnErrorPeriod = {{ .retryOnError }},
        {{- end }}
        {{- if .maxReceivedBytes }}
        maxReceivedMBytes = {{ div .maxReceivedBytes 1048576 }},
        {{- end }}
        {{- if .timeout }}
        timeout = {{ .timeout }},
        {{- end }}
    })
    {{- end }}
    {{- end }}

    {{- if .Values.lua.configScript }}
    -- ==========================================================================
    -- Custom Lua Configuration
    -- ==========================================================================
{{ .Values.lua.configScript | indent 4 }}
    {{- end }}

    pdnslog("Lua Configuration loaded successfully")
  {{- end }}

  {{- if include "powerdns-recursor.luaDnsEnabled" . }}
  dns.lua: |
    --[[
    PowerDNS Recursor DNS Lua Script
    Generated by Helm
    --]]

    pdnslog("Loading DNS Interceptors")

    {{- if .Values.trustAnchors.enabled }}
    -- ==========================================================================
    -- DS Record Responses for Trust Anchors
    -- This ensures DS queries for internal zones are answered correctly
    -- ==========================================================================
    function preresolve(dq)
        local resolved = false

        {{- range .Values.trustAnchors.anchors }}
        if dq.qtype == pdns.DS and dq.qname:equal("{{ .zone }}") then
            dq:addAnswer(pdns.DS, "{{ .dsRecord }}")
            resolved = true
        end
        {{- end }}

        {{- if .Values.lua.dnsScript }}
        -- Custom preresolve logic
        if not resolved then
            -- User-defined preresolve function can override
            local custom_result = custom_preresolve(dq)
            if custom_result ~= nil then
                resolved = custom_result
            end
        end
        {{- end }}

        return resolved
    end
    {{- else if .Values.lua.dnsScript }}
    -- Preresolve function (no trust anchors configured)
    function preresolve(dq)
        return custom_preresolve(dq) or false
    end
    {{- end }}

    {{- if .Values.lua.dnsScript }}
    -- ==========================================================================
    -- Custom DNS Lua Script
    -- ==========================================================================
    function custom_preresolve(dq)
{{ .Values.lua.dnsScript | indent 8 }}
    end
    {{- end }}

    pdnslog("DNS Interceptors loaded successfully")
  {{- end }}
{{- end }}
