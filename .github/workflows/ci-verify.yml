# Copyright Broadcom, Inc. All Rights Reserved.
# SPDX-License-Identifier: APACHE-2.0

name: '[CI/CD] Verify PR'
on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
    branches:
      - main
    paths:
      - 'bitnami/**'
      - '!**.md'

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  get-chart:
    runs-on: ubuntu-latest
    name: Get modified charts
    outputs:
      chart: ${{ steps.get-chart.outputs.chart }}
      result: ${{ steps.get-chart.outputs.result }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
      - id: get-chart
        name: Detect modified chart
        run: |
          files_changed="$(git diff --name-only HEAD~1)"
          charts_dirs_changed="$(echo "$files_changed" | xargs dirname 2>/dev/null | grep -o "bitnami/[^/]*" | sort | uniq || true)"
          num_charts_changed="$(echo "$charts_dirs_changed" | grep -c "bitnami" || true)"

          if [[ "$num_charts_changed" -eq "0" ]]; then
            echo "No charts changed"
            echo "result=skip" >> $GITHUB_OUTPUT
          elif [[ "$num_charts_changed" -eq "1" ]]; then
            chart_name=$(echo "$charts_dirs_changed" | sed "s|bitnami/||g")
            echo "Chart changed: ${chart_name}"
            echo "chart=${chart_name}" >> $GITHUB_OUTPUT
            echo "result=ok" >> $GITHUB_OUTPUT
          else
            echo "Multiple charts changed: ${charts_dirs_changed}"
            echo "result=multiple" >> $GITHUB_OUTPUT
          fi

  lint:
    runs-on: ubuntu-latest
    needs: [get-chart]
    name: Helm Lint
    if: needs.get-chart.outputs.result == 'ok'
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Add dependency repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami || true

      - name: Build dependencies
        env:
          CHART: ${{ needs.get-chart.outputs.chart }}
        run: |
          helm dep build "bitnami/${CHART}" || true

      - name: Run helm lint
        env:
          CHART: ${{ needs.get-chart.outputs.chart }}
        run: |
          helm lint "bitnami/${CHART}"

  template-test:
    runs-on: ubuntu-latest
    needs: [get-chart]
    name: Template Test
    if: needs.get-chart.outputs.result == 'ok'
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Add dependency repos
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami || true

      - name: Build dependencies
        env:
          CHART: ${{ needs.get-chart.outputs.chart }}
        run: |
          helm dep build "bitnami/${CHART}" || true

      - name: Test template rendering
        env:
          CHART: ${{ needs.get-chart.outputs.chart }}
        run: |
          helm template test "bitnami/${CHART}" > /dev/null
